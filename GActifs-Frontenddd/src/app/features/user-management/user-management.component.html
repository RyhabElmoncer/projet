<div class="user-management">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>Gestion des Utilisateurs</h1>
            <div class="header-actions">
                <button
                        class="btn btn-primary"
                        (click)="openCreateModal()"
                        [disabled]="!canManageUsers">
                    <i class="bi bi-plus"></i>
                    Nouvel utilisateur
                </button>
            </div>
        </div>
    </div>

    <!-- Filtres et recherche -->
    <div class="filters-section">
        <div class="search-box">
            <i class="bi bi-search"></i>
            <input
                    type="text"
                    placeholder="Rechercher un utilisateur..."
                    [(ngModel)]="searchTerm"
                    (input)="onSearch()"
                    class="search-input">
        </div>

        <div class="filters">
            <select [(ngModel)]="selectedRole" (change)="onRoleFilter()" class="filter-select">
                <option value="">Tous les rôles</option>
                <option value="ADMIN">Administrateur</option>
                <option value="RESPONSABLE">Responsable</option>
                <option value="TECHNICIEN">Technicien</option>
            </select>

            <select [(ngModel)]="statusFilter" (change)="onStatusFilter()" class="filter-select">
                <option value="">Tous les statuts</option>
                <option value="active">Actifs</option>
                <option value="inactive">Inactifs</option>
            </select>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-cards" *ngIf="stats">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">Total utilisateurs</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.active }}</div>
            <div class="stat-label">Actifs</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.byRole.ADMIN || 0 }}</div>
            <div class="stat-label">Administrateurs</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.byRole.RESPONSABLE || 0 }}</div>
            <div class="stat-label">Responsables</div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" *ngIf="loading">
        <i class="bi bi-arrow-clockwise spin"></i>
        Chargement...
    </div>

    <!-- Table des utilisateurs -->
    <div class="users-table" *ngIf="!loading">
        <table class="table">
            <thead>
            <tr>
                <th>Utilisateur</th>
                <th>Email</th>
                <th>Rôle</th>
                <th>Statut</th>
                <th>Date création</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let user of filteredUsers" [class.inactive]="!user.isActive">
                <td>
                    <div class="user-info">
                        <div class="user-avatar">
                            {{ getInitials(user.firstName, user.lastName) }}
                        </div>
                        <div class="user-details">
                            <div class="user-name">{{ user.firstName }} {{ user.lastName }}</div>
                        </div>
                    </div>
                </td>
                <td>{{ user.email }}</td>
                <td>
                <span class="role-badge" [class]="getRoleClass(user.role)">
                  {{ getRoleLabel(user.role) }}
                </span>
                </td>
                <td>
                <span class="status-badge" [class.active]="user.isActive" [class.inactive]="!user.isActive">
                  {{ user.isActive ? 'Actif' : 'Inactif' }}
                </span>
                </td>
                <td>{{ formatDate(user.createdAt) }}</td>
                <td>
                    <div class="action-buttons">
                        <button
                                class="btn-icon"
                                title="Modifier"
                                (click)="openEditModal(user)"
                                [disabled]="!canManageUsers">
                            <i class="bi bi-pencil"></i>
                        </button>

                        <button
                                class="btn-icon"
                                [title]="user.isActive ? 'Désactiver' : 'Activer'"
                                (click)="toggleUserStatus(user)"
                                [disabled]="!canManageUsers || user.id === currentUserId">
                            <i class="bi" [class.bi-eye-slash]="user.isActive" [class.bi-eye]="!user.isActive"></i>
                        </button>

                        <button
                                class="btn-icon btn-danger"
                                title="Supprimer"
                                (click)="confirmDelete(user)"
                                [disabled]="!canManageUsers || user.id === currentUserId">
                            <i class="bi bi-trash"></i>
                        </button>

                        <button
                                class="btn-icon"
                                title="Réinitialiser mot de passe"
                                (click)="resetUserPassword(user)"
                                [disabled]="!canManageUsers">
                            <i class="bi bi-key"></i>
                        </button>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="no-results" *ngIf="filteredUsers.length === 0">
            <i class="bi bi-person-x"></i>
            <p>Aucun utilisateur trouvé</p>
        </div>
    </div>

    <!-- Modal Création/Modification -->
    <div class="modal" [class.show]="showModal" *ngIf="showModal">
        <div class="modal-backdrop" (click)="closeModal()"></div>
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>{{ isEditMode ? 'Modifier' : 'Créer' }} un utilisateur</h3>
                    <button class="btn-close" (click)="closeModal()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>

                <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">Prénom *</label>
                            <input
                                    type="text"
                                    id="firstName"
                                    formControlName="firstName"
                                    class="form-control"
                                    [class.error]="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched">
                            <div class="error-message" *ngIf="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched">
                                Le prénom est requis
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="lastName">Nom *</label>
                            <input
                                    type="text"
                                    id="lastName"
                                    formControlName="lastName"
                                    class="form-control"
                                    [class.error]="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched">
                            <div class="error-message" *ngIf="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched">
                                Le nom est requis
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input
                                type="email"
                                id="email"
                                formControlName="email"
                                class="form-control"
                                [class.error]="userForm.get('email')?.invalid && userForm.get('email')?.touched">
                        <div class="error-message" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
                            <span *ngIf="userForm.get('email')?.errors?.['required']">L'email est requis</span>
                            <span *ngIf="userForm.get('email')?.errors?.['email']">Format d'email invalide</span>
                        </div>
                    </div>

                    <div class="form-group" *ngIf="!isEditMode">
                        <label for="password">Mot de passe *</label>
                        <input
                                type="password"
                                id="password"
                                formControlName="password"
                                class="form-control"
                                [class.error]="userForm.get('password')?.invalid && userForm.get('password')?.touched">
                        <div class="error-message" *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched">
                            <span *ngIf="userForm.get('password')?.errors?.['required']">Le mot de passe est requis</span>
                            <span *ngIf="userForm.get('password')?.errors?.['minlength']">Le mot de passe doit contenir au moins 8 caractères</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="role">Rôle *</label>
                        <select
                                id="role"
                                formControlName="role"
                                class="form-control"
                                [class.error]="userForm.get('role')?.invalid && userForm.get('role')?.touched">
                            <option value="">Sélectionner un rôle</option>
                            <option value="ADMIN">Administrateur</option>
                            <option value="RESPONSABLE">Responsable</option>
                            <option value="TECHNICIEN">Technicien</option>
                        </select>
                        <div class="error-message" *ngIf="userForm.get('role')?.invalid && userForm.get('role')?.touched">
                            Le rôle est requis
                        </div>
                    </div>

                    <div class="role-permissions" *ngIf="userForm.get('role')?.value">
                        <h4>Permissions pour ce rôle :</h4>
                        <ul class="permissions-list">
                            <li *ngFor="let permission of getSelectedRolePermissions()">{{ permission }}</li>
                        </ul>
                    </div>
                </form>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="closeModal()">
                        Annuler
                    </button>
                    <button
                            type="button"
                            class="btn btn-primary"
                            (click)="onSubmit()"
                            [disabled]="userForm.invalid || submitting">
                        <i class="bi bi-arrow-clockwise spin" *ngIf="submitting"></i>
                        {{ isEditMode ? 'Modifier' : 'Créer' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmation suppression -->
    <div class="modal" [class.show]="showDeleteModal" *ngIf="showDeleteModal">
        <div class="modal-backdrop" (click)="closeDeleteModal()"></div>
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Confirmer la suppression</h3>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer l'utilisateur <strong>{{ userToDelete?.firstName }} {{ userToDelete?.lastName }}</strong> ?</p>
                    <p class="text-danger">Cette action est irréversible.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">
                        Annuler
                    </button>
                    <button
                            type="button"
                            class="btn btn-danger"
                            (click)="deleteUser()"
                            [disabled]="submitting">
                        <i class="bi bi-arrow-clockwise spin" *ngIf="submitting"></i>
                        Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div class="toast" [class.show]="showToast" [class]="toastType">
        <div class="toast-content">
            <i class="bi" [class]="toastIcon"></i>
            <span>{{ toastMessage }}</span>
        </div>
    </div>
</div>